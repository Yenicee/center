{% extends "pacientes/base/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<style>
  /* Badges como en la otra tabla */
  .badge{display:inline-block;padding:.2rem .55rem;border-radius:999px;font-size:.75rem;line-height:1}
  .badge-success{background:#e6f7e9;color:#1b7f3a}
  .badge-warning{background:#fff4e5;color:#8a5a00}
  .badge-secondary{background:#eceef2;color:#3b4455}
  .avatar{width:28px;height:28px;border-radius:50%;vertical-align:middle;margin-right:8px;object-fit:cover}
</style>
{% endblock %}

{% block content %}
  <h1>Pacientes</h1>
  <ul class="breadcrumbs">
    <li><a href="{% url 'patient_list' %}">Dashboard</a></li>
    <li class="divider">/</li>
    <li><a href="#" class="active">Pacientes</a></li>
  </ul>

  <div class="list-header">
    <a href="{% url 'new_patient' %}" class="btn-add">+ Nuevo Paciente</a>
  </div>

  <div class="table-card">
    <table id="patientTable" class="display">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Apellido</th>
          <th>Edad</th>
          <th>Teléfono</th>
          <th>Correo</th>
          <th>Estado</th>
          <th>Terapeuta</th>
          <th>Fecha de registro</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for p in patients %}
        <tr>
          <td data-priority="1">
            {% if p.photo %}
              <img src="{{ p.photo.url }}" alt="" class="avatar">
            {% endif %}
            {{ p.name }}
          </td>
          <td>{{ p.surname }}</td>
          <td>
            <span class="calc-age" data-dob="{{ p.date_of_birth|date:'Y-m-d' }}"></span>
          </td>
          <td>{{ p.phone_number }}</td>
          <td>{{ p.email }}</td>
          <td data-order="{{ p.status }}">
            {% if p.status == "Active" %}
              <span class="badge badge-success">Activo</span>
            {% elif p.status == "Discharged" %}
              <span class="badge badge-secondary">Alta</span>
            {% elif p.status == "Suspended" %}
              <span class="badge badge-warning">Suspendido</span>
            {% else %}
              <span class="badge">-</span>
            {% endif %}
          </td>
          <td>{{ p.therapist }}</td>
          <td data-order="{{ p.created_date|date:'Y-m-d' }}">{{ p.created_date|date:"d/m/Y" }}</td>

          <td class="actions-tab">
            <div class="action-buttons">
              <!-- Mismo estilo de botones que en reservation_list -->
              <a href="{% url 'patient_schedule' p.id %}" class="btn-icon view" title="Ver (Agenda)">
                <i class='bx bx-show'></i>
              </a>
              <a href="{% url 'edit_patient' p.id %}" class="btn-icon edit" title="Editar">
                <i class='bx bx-edit'></i>
              </a>
              <a href="{% url 'delete_patient' p.id %}" class="btn-icon delete" title="Eliminar" onclick="return confirm('¿Eliminar paciente?');">
                <i class='bx bx-trash'></i>
              </a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
  function calcAgeFromDOBStr(dobStr){
    if(!dobStr) return '';
    const dob = new Date(dobStr + 'T00:00:00');
    if (isNaN(dob)) return '';
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
    return age;
  }

  $(function () {
    // Pinta edades
    document.querySelectorAll('.calc-age').forEach(span=>{
      span.textContent = calcAgeFromDOBStr(span.dataset.dob);
    });

    // DataTable igual de simple que en reservations
    $('#patientTable').DataTable({
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
      responsive: true,
      pageLength: 10,
      pagingType: 'full_numbers',
      order: [[7, 'desc']], // fecha de registro
      columnDefs: [{ targets: -1, orderable: false, searchable: false }]
    });
  });
</script>
{% endblock %}
